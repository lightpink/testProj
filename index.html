<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>搬家小物出清</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Noto Sans TC",
          sans-serif;
        background: #fafafa;
        margin: 0;
        padding: 20px;
      }

      h1 {
        text-align: center;
        margin-bottom: 28px;
      }

      .items {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 18px;
      }

      .item {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      /* ===== 卡片圖片區 ===== */
      .images {
        position: relative;
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }

      .images img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        scroll-snap-align: start;
        flex-shrink: 0;
        cursor: zoom-in;
      }

      .dots {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
      }

      .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
      }

      .content {
        padding: 14px 16px 18px;
      }

      .title {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .price {
        color: #d35400;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .desc {
        font-size: 14px;
        color: #555;
        white-space: pre-line;
        line-height: 1.5;
      }

      /* ===== Modal ===== */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      .modal.active {
        display: flex;
      }

      .modal-img {
        max-width: 100%;
        max-height: 100%;
        transform-origin: center center;
        user-select: none;
        -webkit-user-drag: none;
      }

      /* 縮圖列 */
      .thumbs {
        position: absolute;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        overflow-x: auto;
        max-width: 90%;
      }

      .thumbs img {
        width: 56px;
        height: 56px;
        object-fit: cover;
        border-radius: 6px;
        opacity: 0.6;
        cursor: pointer;
        border: 2px solid transparent;
      }

      .thumbs img.active {
        opacity: 1;
        border-color: #fff;
      }

      /* 聯絡 */
      .contact {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 1000;
        display: none;
      }

      .contact a {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        padding: 6px 10px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-decoration: none;
        color: #333;
        font-size: 14px;
      }

      .contact img {
        width: 36px;
        height: 36px;
        border-radius: 6px;
      }
    </style>
  </head>

  <body>
    <div class="contact">
      <a href="https://line.me/ti/p/yUdJOTMl1s" target="_blank">
        <img src="./images/line.jpg" />
        <span>聯繫我（LINE）</span>
      </a>
    </div>

    <h1>搬家小物出清</h1>
    <div id="items" class="items"></div>

    <!-- Modal -->
    <div id="modal" class="modal">
      <img id="modalImg" class="modal-img" />
      <div id="thumbs" class="thumbs"></div>
    </div>

    <script>
      const IMAGE_PATH = "./images/";
      const XLSX_PATH = `./data/items.xlsx?v=${Date.now()}`;

      let currentImages = [];
      let currentIndex = 0;
      let scale = 1,
        posX = 0,
        posY = 0;
      let startDist = 0,
        lastScale = 1;

      fetch(XLSX_PATH)
        .then((r) => r.arrayBuffer())
        .then((buf) => {
          const wb = XLSX.read(buf, { type: "array" });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          rows.shift();

          const container = document.getElementById("items");

          rows.forEach((row) => {
            if (!row[1]) return;
            const [_, name, price, desc, ...images] = row;
            const imgs = images.filter(Boolean);

            const item = document.createElement("div");
            item.className = "item";

            if (imgs.length) {
              const imgBox = document.createElement("div");
              imgBox.className = "images";

              imgs.forEach((f, i) => {
                const img = document.createElement("img");
                img.src = IMAGE_PATH + f;
                img.onclick = () => openModal(imgs, i);
                imgBox.appendChild(img);
              });

              if (imgs.length > 1) {
                const dots = document.createElement("div");
                dots.className = "dots";
                imgs.forEach(() => {
                  const d = document.createElement("div");
                  d.className = "dot";
                  dots.appendChild(d);
                });
                imgBox.appendChild(dots);
              }

              item.appendChild(imgBox);
            }

            const linkedDesc = (desc || "").replace(
              /(https?:\/\/[^\s]+)/g,
              '<a href="$1" target="_blank">$1</a>',
            );

            const content = document.createElement("div");
            content.className = "content";

            content.innerHTML = `
          <div class="title">${name}</div>
          <div class="price">$${price}</div>
          <div class="desc">${linkedDesc}</div>
        `;

            item.appendChild(content);

            container.appendChild(item);
          });
        });

      const modal = document.getElementById("modal");
      const modalImg = document.getElementById("modalImg");
      const thumbs = document.getElementById("thumbs");

      function openModal(images, index) {
        currentImages = images;
        currentIndex = index;
        renderModal();
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function renderModal() {
        modalImg.src = IMAGE_PATH + currentImages[currentIndex];
        thumbs.innerHTML = "";
        currentImages.forEach((f, i) => {
          const t = document.createElement("img");
          t.src = IMAGE_PATH + f;
          if (i === currentIndex) t.classList.add("active");
          t.onclick = (e) => {
            e.stopPropagation();
            currentIndex = i;
            renderModal();
          };
          thumbs.appendChild(t);
        });
        resetTransform();
      }

      function resetTransform() {
        scale = 1;
        posX = posY = 0;
        applyTransform();
      }

      function applyTransform() {
        modalImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
      }

      modal.onclick = (e) => e.target === modal && closeModal();

      function closeModal() {
        modal.classList.remove("active");
        document.body.style.overflow = "";
      }

      // 滾輪
      modal.addEventListener("wheel", (e) => {
        e.preventDefault();
        scale = Math.min(Math.max(1, scale + e.deltaY * -0.001), 4);
        applyTransform();
      });

      // 手機 pinch
      modal.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          startDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY,
          );
          lastScale = scale;
        }
      });

      modal.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2) {
          const dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY,
          );
          scale = Math.min(Math.max(1, lastScale * (dist / startDist)), 4);
          applyTransform();
        }
      });
    </script>
  </body>
</html>
