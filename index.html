<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>搬家小物出清</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Noto Sans TC",
          sans-serif;
        background: #fafafa;
        margin: 0;
        padding: 20px;
      }

      h1 {
        text-align: center;
        margin-bottom: 28px;
      }

      .items {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 18px;
      }

      .item {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .images {
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }

      .images img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        scroll-snap-align: start;
        flex-shrink: 0;
        cursor: zoom-in;
      }

      .content {
        padding: 14px 16px 18px;
      }

      .title {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .price {
        color: #d35400;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .desc {
        font-size: 14px;
        color: #555;
        white-space: pre-line;
        line-height: 1.5;
      }

      /* ===== Modal ===== */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        touch-action: none;
      }

      .modal.active {
        display: flex;
      }

      .modal img {
        max-width: 100%;
        max-height: 100%;
        transform-origin: center center;
        cursor: grab;
        user-select: none;
        -webkit-user-drag: none;
      }

      .close {
        position: absolute;
        top: 14px;
        right: 18px;
        font-size: 28px;
        color: #fff;
        cursor: pointer;
      }

      .nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 40px;
        color: #fff;
        cursor: pointer;
        user-select: none;
        padding: 10px;
      }

      .nav.left {
        left: 10px;
      }
      .nav.right {
        right: 10px;
      }

      .contact {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 1000;
      }

      .contact a {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        padding: 6px 10px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-decoration: none;
        color: #333;
        font-size: 14px;
      }

      .contact img {
        width: 36px;
        height: 36px;
        object-fit: cover;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <div class="contact">
      <a
        href="https://line.me/ti/p/yUdJOTMl1s"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img src="./images/line.jpg" alt="Line QR Code" />
        <span>聯繫我（LINE）</span>
      </a>
    </div>

    <h1>搬家小物出清</h1>

    <div id="items" class="items"></div>

    <!-- Modal -->
    <div id="modal" class="modal">
      <div class="close" id="closeBtn">✕</div>
      <div class="nav left" id="prevBtn">◀</div>
      <img id="modalImg" />
      <div class="nav right" id="nextBtn">▶</div>
    </div>

    <script>
      const IMAGE_PATH = "./images/";
      const XLSX_PATH = `./data/items.xlsx?v=${Date.now()}`; // ✅ 快取破解

      let currentImages = [];
      let currentIndex = 0;

      fetch(XLSX_PATH)
        .then((res) => res.arrayBuffer())
        .then((buffer) => {
          const workbook = XLSX.read(buffer, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          rows.shift();

          const container = document.getElementById("items");

          rows.forEach((row) => {
            if (!row[1]) return;
            const [_, name, price, desc, ...images] = row;
            const validImages = images.filter(Boolean);

            const item = document.createElement("div");
            item.className = "item";

            if (validImages.length) {
              const imgBox = document.createElement("div");
              imgBox.className = "images";

              validImages.forEach((file, idx) => {
                const img = document.createElement("img");
                img.src = IMAGE_PATH + file;
                img.loading = "lazy";
                img.onclick = () => openModal(validImages, idx);
                imgBox.appendChild(img);
              });

              item.appendChild(imgBox);
            }

            const content = document.createElement("div");
            content.className = "content";

            const linkedDesc = (desc || "").replace(
              /(https?:\/\/[^\s]+)/g,
              '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>',
            );

            content.innerHTML = `
          <div class="title">${name}</div>
          <div class="price">$${price}</div>
          <div class="desc">${linkedDesc}</div>
        `;

            item.appendChild(content);
            container.appendChild(item);
          });
        });

      /* ===== Modal Logic ===== */
      const modal = document.getElementById("modal");
      const modalImg = document.getElementById("modalImg");
      const closeBtn = document.getElementById("closeBtn");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      let scale = 1,
        posX = 0,
        posY = 0;

      function openModal(images, index) {
        currentImages = images;
        currentIndex = index;
        showImage();
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function showImage() {
        modalImg.src = IMAGE_PATH + currentImages[currentIndex];
        resetTransform();
      }

      function resetTransform() {
        scale = 1;
        posX = posY = 0;
        applyTransform();
      }

      function applyTransform() {
        modalImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
      }

      function closeModal() {
        modal.classList.remove("active");
        document.body.style.overflow = "";
      }

      closeBtn.onclick = closeModal;
      modal.onclick = (e) => e.target === modal && closeModal();

      prevBtn.onclick = (e) => {
        e.stopPropagation();
        currentIndex =
          (currentIndex - 1 + currentImages.length) % currentImages.length;
        showImage();
      };

      nextBtn.onclick = (e) => {
        e.stopPropagation();
        currentIndex = (currentIndex + 1) % currentImages.length;
        showImage();
      };

      // 滾輪縮放
      modal.addEventListener("wheel", (e) => {
        e.preventDefault();
        scale += e.deltaY * -0.001;
        scale = Math.min(Math.max(1, scale), 4);
        applyTransform();
      });
    </script>
  </body>
</html>
